{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>
      Welcome,
      {% if nurse.profile %}
        {{ nurse.profile.first_name }} {{ nurse.profile.last_name }}
      {% else %}
        No profile
      {% endif %}
    </h3>
    <div>
      <a href="{{ url_for('admin.view_profile', user_id=nurse.id) }}" class="btn btn-info me-2">
        View Profile
      </a>
      <a href="{{ url_for('auth.logout') }}" class="btn btn-danger">Logout</a>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card p-3 text-center shadow">
        <h5>Patients</h5>
        <h2>{{ num_patients }}</h2>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 text-center shadow">
        <h5>Total Medicines</h5>
        <h2>{{ total_meds }}</h2>
      </div>
    </div>
  </div>

  <div class="card shadow mb-4">
    <div class="card-header">Patients List</div>
    <ul class="list-group list-group-flush">
      {% if patients %}
        {% for patient in patients %}
        <li class="list-group-item">
          <a href="#" class="fw-bold text-decoration-none" data-bs-toggle="collapse" data-bs-target="#patient-{{ patient.id }}">
            {% if patient.profile %}
              {{ patient.profile.first_name }} {{ patient.profile.last_name }}
            {% else %}
              No profile
            {% endif %}
          </a>
          - Total Medicines: {{ patient.assigned_medicines|length }}

          <div class="collapse mt-2" id="patient-{{ patient.id }}">
            <form method="POST" action="{{ url_for('admin.add_patient_medicine', patient_id=patient.id) }}" class="mb-3">
              <input type="text" name="name" placeholder="Medicine Name" required class="form-control mb-2">
              <select name="category" required class="form-control mb-2">
                <option value="" disabled selected>Select Category</option>
                <option value="Antibiotic">Antibiotic</option>
                <option value="Analgesic">Analgesic</option>
                <option value="Vitamin">Vitamin</option>
                <option value="Supplement">Supplement</option>
                <option value="Other">Other</option>
              </select>
              <input type="number" name="quantity" placeholder="Quantity" required class="form-control mb-2">
              <input type="number" step="0.01" name="price" placeholder="Price" required class="form-control mb-2">
              <input type="date" name="expires_at" class="form-control mb-2">
              <button type="submit" class="btn btn-success btn-sm">Add Medicine</button>
            </form>

            {% if patient.assigned_medicines %}
            <h6>Assigned Medicines:</h6>
            <ul class="list-group mb-2">
              {% for med in patient.assigned_medicines %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ med.name }}</strong> - {{ med.category }},
                  Qty: {{ med.quantity }}, Price: ₱{{ "%.2f"|format(med.price) }},
                  Total: ₱{{ "%.2f"|format(med.total_value) }},
                  Issued: {{ med.issued_at.strftime('%Y-%m-%d %H:%M') }}
                  {% if med.expires_at %}- Expires: {{ med.expires_at.strftime('%Y-%m-%d') }}{% endif %}
                </div>
                <div>
                  <a href="{{ url_for('admin.edit_medicine', med_id=med.id) }}" class="btn btn-warning btn-sm me-2">Edit</a>
                  <a href="{{ url_for('admin.delete_medicine', med_id=med.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this medicine?');">Delete</a>
                </div>
              </li>
              {% endfor %}
            </ul>
            <p class="text-end fw-bold">
              Total Cost: ₱{{ "%.2f"|format(patient_totals.get(patient.id, 0)) }}
            </p>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      {% else %}
        <li class="list-group-item">No patients found.</li>
      {% endif %}
    </ul>
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}
{% endblock %}
